---
title: "apache enableMMAP option"
date: "2022-09-27"
tags:
  - apache
  - error
---

# apache enableMMAP option

## apache enableMMAP 옵션이란

아파치의 설정의 대문인 httpd.conf에서 설정할 수 있는 옵션으로,
아파치에서 사용하는 static한 값들을 메모리에 띄워둔 채로 사용할 수 있게 하는 옵션이다.
이 옵션을 사용함으로써 apache에서 빈번하게 읽게 되는 파일이 있다면,
파일을 매번 입력받는 것이 아니라 한번 입력받은 파일을 메모리에 계속 띄워둠으로써 성능 향상을 할 수 있다.
이 옵션은 on이 기본값이다.

## 계기

이 옵션을 알게 된 계기는 담당하는 서버에서 core dump가 생긴 것이 계기였다.

core dump란 linux 서버에 있는 기능 중 하나로, 프로세스가 정상적이지 않은 에러로 인해 종료될 경우 실행되던 프로세스에 관한 정보를 모두 담아놓은 core를 생성해주는 기능이다.

이를 분석할 때 gdb란 툴을 사용하여 할 수 있는데, 사용법은 여기서 다룰 건 아닌 것 같아서 넘어간다.

어찌됐건 core에서 발견된 에러 메세지는 다음과 같았다.

```
Program terminated with signal 7, Bus error.
#0  0x00007fb2f7cd611a in __memcpy_ssse3_back () from /lib64/libc.so.6
```

해석하면 프로그램이 signal 7 Bus error로 인해 종료되었고, 마지막으로 실행되던 프로그램 소스의 위치가 /lib64/libc.so.6의 \_\_memcpy_ssse3_back이라는 함수 안이였다는 뜻이다.

signal을 봐도 그렇고, 종료된 위치를 봐도 그렇고 결국 런타임 중에 메모리 영역의 이상이 있었기 때문에 종료되었다는 뜻이다.

## 해결 과정

메모리 영역의 이상이라고 하면, 네게 제일 먼저 떠오르는 것은 쓰레드 문제였다.

apache에 대해서 잘 아는 것이 아니기 때문에, 정확히 무엇이 원인이라 일어났는지 파악하는 것은 무리였고 쓰레드를 쓰고 있는지부터 해서 쓰레드 관련 옵션 중에 위험한 것이 무엇이 있는지를 전부 뒤져야 했다.

다행히도 찾아보던 중 비슷한 증상을 가진 글과 해결법을 찾아서 enableMMAP 옵션이 위와 같은 에러를 낼 수 있다는 것을 들었고, 서버에 적용하면서 실제로 이 옵션이 core dump의 원인이었다는 것을 찾을 수 있었다.

추정된 원인은 enableMMAP는 메모리 위에 파일을 올리는 옵션인 만큼 쓰레드를 사용하는 옵션과 사용하려면 올리는 메모리가 쓰레드간에 충돌이 없는 곳이란 보장이 필요한데, thread-safe한 옵션이 아니다.

apache를 prefork와 같이 thread를 안 쓰는 형태로 사용했다면, 아마 enableMMAP가 효율도 높여주고 문제를 일으키지도 않았겠지만 서버 설정상 thread를 사용하는 형태였기 때문에 옵션간 충돌이 일어나 core dump가 났던 것이었다.

얻은 교훈은 쓰레드를 쓸거면 잘 알아보고 써야하며, 뭔가 문제가 생기면 소위 thread-safe하지 않은 옵션부터 의심해봐야한다는 점이다.
